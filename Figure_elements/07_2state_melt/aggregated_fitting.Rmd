---
title: "Aggregated fitting kadd_curves"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
# Packages
library(DBI)
library(RSQLite)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(broom)

# --- Load data ---------------------------------------------------------------

global_fits <- "../06_aggfit_ntp_adduction/reference/EKC.01.061.analyze_fit_distributions/global_refit_results_withCs.db"
con1 <- dbConnect(RSQLite::SQLite(), global_fits)
fits <- dbGetQuery(con1, "SELECT * FROM global_fits")
dbDisconnect(con1)

# get experimental info
main_db <- "../06_aggfit_ntp_adduction/reference/EKC.01.060.developing_DB_input/new.db"
con2 <- dbConnect(RSQLite::SQLite(), main_db)

exp_info <- dbGetQuery(
  con2,
  "
  SELECT
    pr.temperature,
    c.disp_name,
    rg.rg_id,
    pr.buffer_id
  FROM reaction_groups rg
  LEFT JOIN probing_reactions pr ON rg.rxn_id = pr.id
  JOIN constructs c ON pr.construct_id = c.id
  WHERE pr.RT = 'MRT'
  GROUP BY rg.rg_id
  "
)
dbDisconnect(con2)

# harmonize & join
fits <- fits %>%
  mutate(rg_id = as.integer(rg_id)) %>%
  left_join(exp_info, by = "rg_id") %>%
  distinct() %>%                        # drop duplicates
  filter(temperature < 85)              # filter fits to under 85C

# quick peek
names(fits)
```


```{r}
sites_keep <- c(7, 15, 16, 18, 26, 29)
disp_keep  <- c("4U_wt", "4U_a8c")

# --- PREP DATA ---------------------------------------------------------------
dat <- fits %>%
  mutate(
    log_kobs = log_kappa + log_kdeg,
    inv_T = 1 / (temperature + 273.15),
    stderr_log_kobs = sqrt(stderr_log_kappa^2 + stderr_log_kdeg^2),
    weight = 1 / (stderr_log_kobs^2)
  ) %>%
  filter(site %in% sites_keep, disp_name %in% disp_keep) %>%
  filter(is.finite(inv_T), is.finite(log_kobs), is.finite(weight)) %>%
  filter(temperature > 59)

# --- INDIVIDUAL FITS ---------------------------------------------------------
fits_indiv <- dat %>%
  group_by(site, disp_name) %>%
  do({
    m <- lm(log_kobs ~ inv_T, data = ., weights = weight)
    broom::tidy(m) %>%
      select(term, estimate) %>%
      pivot_wider(names_from = term, values_from = estimate) %>%
      rename(intercept_indiv = `(Intercept)`, slope_indiv = inv_T) %>%
      mutate(r2_indiv = summary(m)$r.squared)
  }) %>%
  ungroup()

# --- AGGREGATED FITS ---------------------------------------------------------
dat_agg <- dat %>%
  group_by(site, disp_name, inv_T) %>%
  summarize(
    mean_log_kobs = mean(log_kobs, na.rm = TRUE),
    sd_log_kobs   = sd(log_kobs, na.rm = TRUE),
    weight = 1 / (sd_log_kobs^2),
    .groups = "drop"
  ) %>%
  filter(is.finite(mean_log_kobs), is.finite(inv_T), is.finite(weight))

fits_agg <- dat_agg %>%
  group_by(site, disp_name) %>%
  do({
    m <- lm(mean_log_kobs ~ inv_T, data = ., weights = weight)
    broom::tidy(m) %>%
      select(term, estimate) %>%
      pivot_wider(names_from = term, values_from = estimate) %>%
      rename(intercept_agg = `(Intercept)`, slope_agg = inv_T) %>%
      mutate(r2_agg = summary(m)$r.squared)
  }) %>%
  ungroup()

# --- COMPARE -----------------------------------------------------------------
fit_compare <- fits_indiv %>%
  full_join(fits_agg, by = c("site", "disp_name")) %>%
  mutate(
    slope_diff = slope_agg - slope_indiv,
    intercept_diff = intercept_agg - intercept_indiv,
    r2_diff = r2_agg - r2_indiv
  )

# View comparison
fit_compare %>%
  select(site, disp_name,
         slope_indiv, slope_agg, slope_diff,
         r2_indiv, r2_agg, r2_diff) %>%
  arrange(desc(abs(slope_diff))) %>%
  print(n = Inf)

# --- OPTIONAL: visualize slope comparison ------------------------------------
ggplot(fit_compare, aes(x = slope_indiv, y = slope_agg, color = disp_name)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray50") +
  geom_point(size = 3) +
  labs(
    x = "Slope (1/T) from individual fits",
    y = "Slope (1/T) from aggregated fits",
    title = "Comparison of Arrhenius slopes: individual vs aggregated"
  ) +
  theme_minimal()
```
